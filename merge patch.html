<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>던전 크롤러 - 겹침 패치 통합판</title>
  <style>
    body { background: #111; color: #eee; font-family: sans-serif; text-align: center; }
    .grid { display: grid; grid-template-columns: repeat(10, 32px); grid-gap: 2px; justify-content: center; margin-top: 20px; }
    .cell { width: 32px; height: 32px; background: #333; display: flex; align-items: center; justify-content: center; font-weight: bold; border-radius: 4px; }
    .player { background: green; color: white; }
    .monster { background: red; color: white; }
    .mercenary { background: #2196F3; color: white; }
    .log { max-height: 120px; overflow-y: auto; font-size: 14px; background: #222; padding: 10px; margin-top: 10px; border-radius: 5px; }
    .buttons { margin-top: 15px; }
    .buttons button { background: #444; color: white; font-size: 20px; margin: 5px; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
    .buttons button:hover { background: #666; }
    .mercenaries { background: #333; padding: 10px; border-radius: 5px; margin-top: 15px; max-width: 300px; margin-left: auto; margin-right: auto; }
    .mercenary-info { margin-bottom: 10px; padding: 5px; background-color: #444; border-radius: 3px; }
  </style>
</head>
<body>
  <h1>던전 크롤러 - 겹침 패치 통합판</h1>
  <div class="grid" id="grid"></div>
  <div class="log" id="log"></div>
  <div class="buttons">
    <div><button onclick="movePlayer(0,-1)">↑</button></div>
    <div>
      <button onclick="movePlayer(-1,0)">←</button>
      <button onclick="movePlayer(1,0)">→</button>
    </div>
    <div><button onclick="movePlayer(0,1)">↓</button></div>
  </div>
  <div class="mercenaries">
    <h2>용병 정보</h2>
    <div id="mercenary-list"></div>
  </div>

  <script>
    const gridSize = 10;
    const grid = document.getElementById('grid');
    const log = document.getElementById('log');

    const gameState = {
      player: { x: 1, y: 1 },
      mercenaries: [],
      monsters: [{ x: 5, y: 5, health: 10, defense: 1 }]
    };

    const MERCENARY_TYPES = {
      WARRIOR: { name: '전사', icon: 'W', color: '#4169E1', baseHealth: 15, baseAttack: 4, baseDefense: 2, salary: 10, range: 1 }
    };

    function createMercenary(type, x, y) {
      const t = MERCENARY_TYPES[type];
      return {
        id: Math.random().toString(36).substr(2, 9),
        name: t.name,
        icon: t.icon,
        color: t.color,
        x: x, y: y,
        health: t.baseHealth,
        maxHealth: t.baseHealth,
        attack: t.baseAttack,
        defense: t.baseDefense,
        level: 1,
        exp: 0,
        expNeeded: 20,
        range: t.range,
        alive: true
      };
    }

    gameState.mercenaries.push(createMercenary('WARRIOR', 2, 1));

    function render() {
      grid.innerHTML = '';
      for (let y = 0; y < gridSize; y++) {
        for (let x = 0; x < gridSize; x++) {
          const cell = document.createElement('div');
          cell.className = 'cell';

          const hasPlayer = gameState.player.x === x && gameState.player.y === y;
          const hasMercenary = gameState.mercenaries.some(m => m.x === x && m.y === y && m.alive);
          const hasMonster = gameState.monsters.some(m => m.x === x && m.y === y && m.health > 0);

          if (hasPlayer && hasMercenary) {
            cell.classList.add('player');
            cell.style.border = '2px solid dodgerblue';
            cell.textContent = '@+M';
            cell.style.fontSize = '10px';
          } else if (hasPlayer) {
            cell.classList.add('player');
            cell.textContent = '@';
          } else if (hasMercenary) {
            const m = gameState.mercenaries.find(m => m.x === x && m.y === y);
            cell.classList.add('mercenary');
            cell.textContent = m.icon;
            cell.style.color = m.color;
          } else if (hasMonster) {
            cell.classList.add('monster');
            cell.textContent = 'Z';
          }

          grid.appendChild(cell);
        }
      }
    }

    function logMsg(msg) {
      const div = document.createElement('div');
      div.textContent = msg;
      log.appendChild(div);
      log.scrollTop = log.scrollHeight;
    }

    function updateMercenaryDisplay() {
      const list = document.getElementById('mercenary-list');
      list.innerHTML = '';
      if (gameState.mercenaries.length === 0) {
        list.innerHTML = '<div style="color:#888">용병 없음</div>';
        return;
      }
      gameState.mercenaries.forEach(m => {
        const el = document.createElement('div');
        el.className = 'mercenary-info';
        el.innerHTML = `<strong>${m.icon} ${m.name}</strong><br>체력: ${m.health}/${m.maxHealth}<br>공격력: ${m.attack}<br>방어력: ${m.defense}<br>Lv.${m.level}`;
        list.appendChild(el);
      });
    }

    function processMercenariesTurn() {
      gameState.mercenaries.forEach(m => {
        if (!m.alive) return;

        const dx = gameState.player.x - m.x;
        const dy = gameState.player.y - m.y;
        if (Math.abs(dx) > Math.abs(dy)) m.x += Math.sign(dx);
        else m.y += Math.sign(dy);

        for (const mon of gameState.monsters) {
          if (Math.abs(mon.x - m.x) + Math.abs(mon.y - m.y) <= m.range && mon.health > 0) {
            const dmg = Math.max(1, m.attack - mon.defense);
            mon.health -= dmg;
            logMsg(`${m.name} → 몬스터 ${dmg} 피해`);
            if (mon.health <= 0) {
              logMsg(`몬스터 제거됨!`);
              m.exp += 10;
              if (m.exp >= m.expNeeded) {
                m.level++;
                m.exp = 0;
                m.maxHealth += 5;
                m.health = m.maxHealth;
                m.attack += 1;
                m.defense += 1;
                logMsg(`${m.name} 레벨업! Lv.${m.level}`);
              }
            }
            break;
          }
        }
      });

      gameState.monsters = gameState.monsters.filter(m => m.health > 0);
    }

    function movePlayer(dx, dy) {
      gameState.player.x = Math.max(0, Math.min(gridSize - 1, gameState.player.x + dx));
      gameState.player.y = Math.max(0, Math.min(gridSize - 1, gameState.player.y + dy));
      processMercenariesTurn();
      render();
      updateMercenaryDisplay();
    }

    document.addEventListener('keydown', (e) => {
      const keys = {
        ArrowUp: [0, -1], ArrowDown: [0, 1],
        ArrowLeft: [-1, 0], ArrowRight: [1, 0],
        w: [0, -1], s: [0, 1], a: [-1, 0], d: [1, 0]
      };
      const dir = keys[e.key.toLowerCase()];
      if (dir) movePlayer(...dir);
    });

    render();
    updateMercenaryDisplay();
  </script>
</body>
</html>
